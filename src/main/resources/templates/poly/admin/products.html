<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản phẩm - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- Header & Buttons --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #1a202c;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        /* --- Stats Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.05);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h3 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #2d3748; }
        .stat-info p { margin: 0; color: #718096; font-size: 0.9rem; font-weight: 500; }

        .bg-purple-light { background: #f3e8ff; color: #805ad5; }
        .bg-green-light { background: #def7ec; color: #047857; }
        .bg-red-light { background: #fde8e8; color: #c81e1e; }
        .bg-blue-light { background: #e1effe; color: #1a56db; }

        /* --- Filter & Search --- */
        .filter-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid #f0f0f0;
        }

        .filter-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto auto;
            gap: 15px;
            align-items: center;
        }

        .form-control-custom, .form-select-custom {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            width: 100%;
            transition: border-color 0.2s;
        }

        .form-control-custom:focus, .form-select-custom:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-filter {
            background: #2d3748;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-filter:hover { background: #4a5568; }

        .btn-reset {
            background: white;
            color: #718096;
            border: 1px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-reset:hover { background: #f7fafc; color: #2d3748; }

        /* --- Product Table --- */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        .table {
            width: 100%;
            margin-bottom: 0;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 15px 20px;
            border-bottom: 1px solid #edf2f7;
        }

        .table td {
            padding: 15px 20px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
        }

        .product-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-img {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }

        .product-info h4 {
            margin: 0 0 4px;
            font-size: 1rem;
            font-weight: 600;
        }

        .product-info span {
            font-size: 0.85rem;
            color: #718096;
        }

        .price-text {
            font-weight: 700;
            color: #2d3748;
        }

        .promotion-badge {
            background: #fff5f5;
            color: #e53e3e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .btn-back {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-back:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-in { background: #def7ec; color: #03543f; }
        .status-low { background: #fffaf0; color: #9c4221; }
        .status-out { background: #fde8e8; color: #9b1c1c; }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-edit { background: #ebf8ff; color: #3182ce; }
        .btn-edit:hover { background: #3182ce; color: white; }

        .btn-delete { background: #fff5f5; color: #e53e3e; }
        .btn-delete:hover { background: #e53e3e; color: white; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        .empty-state i {
            font-size: 4rem;
            color: #e2e8f0;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .filter-form { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 576px) {
            .filter-form { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn-add { width: 100%; justify-content: center; }
        }
        
        .rating-stars { color: #f59e0b; font-size: 0.9rem; }
        
        /* Alert */
        .alert-float {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease;
            background: white;
            border-left: 5px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .alert-success { border-color: #48bb78; color: #2f855a; }
        .alert-error { border-color: #f56565; color: #c53030; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="font-weight: bold; font-size: 1.2rem;"><i class="fas fa-shield-alt"></i> Admin Panel</div>
        <div>
            <a href="/admin/dashboard" style="color: white; text-decoration: none; margin-right: 20px; font-weight: 500;"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/home" style="color: rgba(255,255,255,0.8); text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Thoát</a>
        </div>
    </div>

    <div class="main-content">
        <div th:if="${message}" class="alert-float" 
             th:classappend="${messageType == 'success' ? 'alert-success' : 'alert-error'}">
            <i th:class="${messageType == 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'}"></i>
            <span th:text="${message}"></span>
        </div>

        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-box-open text-primary"></i> Quản lý Sản phẩm</h1>
            
            <a href="/admin/dashboard" class="btn-back">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="/admin/product/add" class="btn-add">
                <i class="fas fa-plus"></i> Thêm sản phẩm mới
            </a>
        </div>

        <div class="stats-grid" th:if="${products != null}">
            <div class="stat-card bg-blue-light">
                <div class="stat-icon bg-white text-primary"><i class="fas fa-cubes"></i></div>
                <div class="stat-info">
                    <h3 th:text="${#lists.size(products)}">0</h3>
                    <p>Tổng sản phẩm</p>
                </div>
            </div>
            <div class="stat-card bg-green-light">
                <div class="stat-icon bg-white text-success"><i class="fas fa-check"></i></div>
                <div class="stat-info">
                    <h3 th:text="${#lists.size(products.?[quantity > 10])}">0</h3>
                    <p>Còn hàng nhiều</p>
                </div>
            </div>
            <div class="stat-card bg-red-light">
                <div class="stat-icon bg-white text-danger"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <h3 th:text="${#lists.size(products.?[quantity == 0])}">0</h3>
                    <p>Đã hết hàng</p>
                </div>
            </div>
            <div class="stat-card bg-purple-light">
                <div class="stat-icon bg-white text-purple"><i class="fas fa-tags"></i></div>
                <div class="stat-info">
                    <h3 th:text="${#lists.size(products.?[promotionId != null])}">0</h3>
                    <p>Đang khuyến mãi</p>
                </div>
            </div>
        </div>

        <div class="filter-card">
            <form action="/admin/products" method="get" class="filter-form">
                <div>
                    <input type="text" name="search" class="form-control-custom" 
                           placeholder="Tìm kiếm theo tên sản phẩm..." 
                           th:value="${param.search}">
                </div>
                
                <div>
                    <select name="category" class="form-select-custom">
                        <option value="">-- Tất cả danh mục --</option>
                        <option th:each="cat : ${categories}" 
                                th:value="${cat.categoryId}" 
                                th:text="${cat.name}"
                                th:selected="${param.category != null && param.category.toString() == cat.categoryId.toString()}">
                        </option>
                    </select>
                </div>

                <div>
                    <select name="stock" class="form-select-custom">
                        <option value="">-- Tình trạng kho --</option>
                        <option value="in" th:selected="${param.stock == 'in'}">Còn hàng</option>
                        <option value="low" th:selected="${param.stock == 'low'}">Sắp hết (< 10)</option>
                        <option value="out" th:selected="${param.stock == 'out'}">Hết hàng</option>
                    </select>
                </div>

                <button type="submit" class="btn-filter">
                    <i class="fas fa-filter"></i> Lọc
                </button>
                
                <a href="/admin/products" class="btn-reset">
                    <i class="fas fa-redo"></i>
                </a>
            </form>
        </div>

        <div class="table-container">
            <div th:if="${products.isEmpty()}" class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>Không tìm thấy sản phẩm nào</h3>
                <p>Thử thay đổi bộ lọc hoặc thêm sản phẩm mới</p>
            </div>

            <table class="table" th:if="${!products.isEmpty()}">
                <thead>
                    <tr>
                        <th width="40%">Sản phẩm</th>
                        <th>Danh mục</th>
                        <th>Giá bán</th>
                        <th>Tồn kho</th>
                        <th>Đánh giá</th>
                        <th class="text-end">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="p : ${products}">
                        <td>
                            <div class="product-cell">
                                <img th:src="${p.imageUrl}" 
                                     onerror="this.src='https://via.placeholder.com/60'" 
                                     class="product-img" alt="Product">
                                <div class="product-info">
                                    <h4 th:text="${p.name}">Tên sản phẩm</h4>
                                    <span>ID: <span th:text="${p.productId}"></span></span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border" 
                                  th:text="${p.category != null ? p.category.name : 'Chưa phân loại'}">Category</span>
                        </td>
                        <td>
                            <span class="price-text" th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</span>
                            <div th:if="${p.promotion != null}">
                                <span class="promotion-badge">
                                    -<span th:text="${#numbers.formatPercent(p.promotion.discount, 0, 0)}"></span>
                                </span>
                            </div>
                        </td>
                        <td>
                            <span th:class="'status-badge ' + (${p.quantity == 0} ? 'status-out' : (${p.quantity < 10} ? 'status-low' : 'status-in'))">
                                <i th:class="${p.quantity == 0} ? 'fas fa-times-circle' : 'fas fa-check-circle'"></i>
                                <span th:text="${p.quantity == 0 ? 'Hết hàng' : (p.quantity + ' sản phẩm')}"></span>
                            </span>
                        </td>
                        <td>
                            <div class="rating-stars">
                                <i class="fas fa-star"></i> <span th:text="${p.rating}">0.0</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a th:href="@{'/admin/product/edit/' + ${p.productId}}" class="btn-icon btn-edit" title="Chỉnh sửa">
                                    <i class="fas fa-pen"></i>
                                </a>
                                
                                <form th:action="@{'/admin/product/delete/' + ${p.productId}}" method="post" 
                                      onsubmit="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này? Hành động này không thể hoàn tác!');">
                                    <button type="submit" class="btn-icon btn-delete" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center mt-4" th:if="${totalPages != null && totalPages > 1}">
            <div class="btn-group">
                <a th:if="${currentPage > 0}" 
                   th:href="@{/admin/products(page=${currentPage - 1}, search=${param.search}, category=${param.category}, stock=${param.stock})}" 
                   class="btn btn-white border">Trước</a>
                   
                <button class="btn btn-primary disabled" th:text="${currentPage + 1} + ' / ' + ${totalPages}"></button>
                
                <a th:if="${currentPage < totalPages - 1}" 
                   th:href="@{/admin/products(page=${currentPage + 1}, search=${param.search}, category=${param.category}, stock=${param.stock})}" 
                   class="btn btn-white border">Sau</a>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto hide alert
        setTimeout(function() {
            const alert = document.querySelector('.alert-float');
            if(alert) {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(100%)';
                alert.style.transition = 'all 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }
        }, 4000);
    </script>
</body>
</html>